// ACE-Step V1.5 Model Architecture
// Hybrid Two-Brain Architecture: Language Model (Planner) + DiT (Executor)

digraph ACEStep {
    rankdir=TB;
    splines=ortho;
    node [fontname="Helvetica", fontsize=12, style="bold", fillcolor="none"];
    edge [fontname="Helvetica", fontsize=10];
    bgcolor="transparent";

    // === INPUT LAYER ===
    subgraph cluster_input {
        label="Inputs";
        style=rounded;
        bgcolor="none";
        color="#4169E1";
        penwidth=2;

        instruction [label="Instruction\nCaption\nMetas", shape=box, color="#4169E1", penwidth=2];
        lyrics [label="Lyrics\n(â‰¤4096 chars)", shape=box, color="#4169E1", penwidth=2];
        refer_audio [label="Reference Audio\n(style transfer)", shape=box, color="#4169E1", penwidth=2];
        src_audio [label="Source Audio\n(cover/repaint)", shape=box, color="#4169E1", penwidth=2];
    }

    // === TEXT ENCODERS ===
    subgraph cluster_encoders {
        label="Text Encoders";
        style=rounded;
        bgcolor="none";
        color="#228B22";
        penwidth=2;

        qwen3_emb [label="Qwen3-0.6B-emb\n(Text Encoder)\nâ„ï¸ frozen", shape=box, color="#228B22", penwidth=2];
        lyric_encoder [label="Lyric Encoder\nğŸ”¥ trainable", shape=box, color="#FF6600", penwidth=2];
        timbre_encoder [label="Timbre Encoder\nğŸ”¥ trainable", shape=box, color="#FF6600", penwidth=2];
    }

    // === VAE ===
    subgraph cluster_vae {
        label="VAE (AutoencoderOobleck)";
        style=rounded;
        bgcolor="none";
        color="#228B22";
        penwidth=2;

        vae_encoder [label="1D VAE Encoder\nâ„ï¸ frozen\n(Ã—1920 compression)", shape=box, color="#228B22", penwidth=2];
        vae_decoder [label="1D VAE Decoder\nâ„ï¸ frozen", shape=box, color="#228B22", penwidth=2];
    }

    // === DiT CORE ===
    subgraph cluster_dit {
        label="DiT (Diffusion Transformer) with SWA";
        style=rounded;
        bgcolor="none";
        color="#DAA520";
        penwidth=2;

        // Positional encodings
        rope [label="RoPE\n(Position)", shape=ellipse, color="#DAA520", penwidth=2];
        time_emb [label="Time Embedding\n(Timestep)", shape=ellipse, color="#DAA520", penwidth=2];

        // DiT blocks
        subgraph cluster_dit_block {
            label="DiT Block (Ã—N)";
            style=dashed;
            bgcolor="none";
            color="#B8860B";
            penwidth=2;

            self_attn [label="Self-Attention", shape=box, color="#DAA520", penwidth=2];
            cross_attn [label="Cross-Attention\nğŸ”¥ trainable", shape=box, color="#FF6600", penwidth=2];
            ffn [label="FFN\n(Feed Forward)", shape=box, color="#DAA520", penwidth=2];
        }

        patch [label="patch=2", shape=plaintext];
    }

    // === AUDIO TOKENIZER (for LM) ===
    subgraph cluster_audio_tokenizer {
        label="Audio Tokenizer (5Hz LM Interface)";
        style=rounded;
        bgcolor="none";
        color="#8B008B";
        penwidth=2;

        target_latent [label="target latent", shape=box, color="#8B008B", penwidth=2];
        attention_pooler [label="Attention Pooler", shape=box, color="#8B008B", penwidth=2];
        hidden_5hz [label="5Hz hidden", shape=box, color="#8B008B", penwidth=2];
        fsq [label="FSQ\n(Finite Scalar Quantization)", shape=box, color="#8B008B", penwidth=2];
        audio_codes [label="5Hz Audio Codes\n(for LM)", shape=box, color="#8B008B", penwidth=2];

        // Cover path
        src_latent [label="src latent\n(for cover)", shape=box, color="#8B008B", penwidth=2];
        latent_25hz [label="25Hz latent", shape=box, color="#8B008B", penwidth=2];
        attention_unpooler [label="Attention Unpooler", shape=box, color="#8B008B", penwidth=2];
        quantized_5hz [label="5Hz quantized\nhidden", shape=box, color="#8B008B", penwidth=2];
    }

    // === 5Hz LANGUAGE MODEL ===
    subgraph cluster_lm {
        label="5Hz Language Model (Planner)";
        style=rounded;
        bgcolor="none";
        color="#DC143C";
        penwidth=2;

        lm [label="5Hz LM\n(0.6B / 1.7B / 4B)\nQwen3-based\nğŸ”¥ trainable", shape=box, color="#FF6600", penwidth=2];
        cot [label="Chain-of-Thought\nReasoning", shape=ellipse, color="#DC143C", penwidth=2];
        metadata_out [label="Metadata Output\n(BPM, Key, Time Sig)", shape=box, color="#DC143C", penwidth=2];
        semantic_codes [label="Semantic Audio Codes\n(composition, timbre)", shape=box, color="#DC143C", penwidth=2];
    }

    // === OUTPUT ===
    subgraph cluster_output {
        label="Output";
        style=rounded;
        bgcolor="none";
        color="#DC143C";
        penwidth=2;

        output_audio [label="Output Audio\n48kHz Ã— 2ch\n(10s ~ 10min)", shape=box, color="#DC143C", penwidth=2];
    }

    // === CONNECTIONS ===

    // Input to Encoders
    instruction -> qwen3_emb;
    lyrics -> lyric_encoder;
    refer_audio -> timbre_encoder;

    // Audio to VAE
    src_audio -> vae_encoder;

    // Encoders to DiT
    qwen3_emb -> cross_attn;
    lyric_encoder -> cross_attn;
    timbre_encoder -> cross_attn;

    // VAE to DiT
    vae_encoder -> patch -> self_attn;

    // Position/Time embeddings
    rope -> self_attn;
    time_emb -> self_attn;

    // DiT internal flow
    self_attn -> cross_attn -> ffn;

    // DiT output paths
    ffn -> target_latent [label="  generate"];
    ffn -> vae_decoder [label="  decode"];

    // Audio Tokenizer flow
    target_latent -> attention_pooler -> hidden_5hz -> fsq -> audio_codes;

    // Cover path
    src_latent -> latent_25hz -> attention_unpooler -> quantized_5hz;
    quantized_5hz -> fsq;

    // LM connections
    audio_codes -> lm;
    lm -> cot;
    cot -> metadata_out;
    cot -> semantic_codes;
    semantic_codes -> cross_attn [style=dashed, label="  hints"];

    // Final output
    vae_decoder -> output_audio;

    // Legend
    subgraph cluster_legend {
        label="Legend";
        style=rounded;
        bgcolor="none";
        color="#666666";
        penwidth=1;

        leg_frozen [label="â„ï¸ Frozen (green border)", shape=plaintext];
        leg_train [label="ğŸ”¥ Trainable (orange border)", shape=plaintext];
    }
}
